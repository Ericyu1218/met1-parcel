<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>MET 1 Parcel System (PWA Ver.)</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#D00000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --met-red: #D00000; --met-black: #000000; }
    body { background-color: #f8f9fa; padding-bottom: 100px; font-family: -apple-system, system-ui, sans-serif; }
    
    /* Header & UI Components */
    .app-header { background-color: var(--met-black); color: white; padding: 10px 15px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .app-logo { height: 30px; margin-right: 10px; }
    .menu-trigger { cursor: pointer; padding: 5px; font-size: 1.5rem; }
    
    .staff-bar { background: white; padding: 8px 15px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 10px; }
    .staff-input { border: 1px solid #ccc; border-radius: 5px; padding: 4px 8px; flex-grow: 1; font-weight: bold; }
    
    /* Badges & Info Boxes */
    .no-email-badge { background-color: #ff4d4d; color: white; font-size: 0.65rem; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-left: 5px; }
    .unit-info-box { font-size: 0.9rem; margin-top: 5px; padding: 5px 10px; border-radius: 5px; background: #e7f3ff; color: #0056b3; }
    .monthly-badge { background: #ffeded; color: #d00000; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    
    /* Navigation */
    .nav-bottom { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; height: 65px; display: flex; z-index: 1000; }
    .nav-btn { flex: 1; border: none; background: none; color: #6c757d; font-size: 0.7rem; padding-top: 10px; }
    .nav-btn.active { color: var(--met-red); font-weight: bold; }
    
    /* Parcel Cards */
    .parcel-card { background: white; border-radius: 8px; margin-bottom: 10px; padding: 12px; border: 2px solid transparent; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .parcel-card.selected { border-color: var(--met-red); background-color: #fff5f5; }
    .custom-check { width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
    .selected .custom-check { background: var(--met-red); border-color: var(--met-red); color: white; display: flex; align-items: center; justify-content: center; }
    .selected .custom-check::after { content: 'âœ“'; font-size: 14px; }
    
    /* Dropdown & Overlays */
    .custom-dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 1050; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .dropdown-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    #toolOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: none; overflow-y: auto; }
    .overlay-header { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    
    /* Storage Visualizer */
    .location-header { background: #f0f0f0; padding: 5px 10px; font-weight: bold; border-left: 4px solid #333; margin-top: 15px; }
    .storage-row { display: flex; border-bottom: 1px solid #eee; padding: 8px 0; align-items: center; }
    .range-label { width: 120px; font-weight: bold; font-size: 0.8rem; color: #666; flex-shrink: 0; }
    .unit-container { display: flex; flex-wrap: wrap; gap: 5px; }
    .unit-tag { background: #f8f9fa; border: 1px solid #ddd; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 500; cursor: pointer; }
    
    /* Signature Pad */
    #signature-pad { border: 2px dashed #ccc; background: #fff; width: 100%; height: 200px; touch-action: none; }
    
    /* Location Colors */
    .bg-loc-lobby { background-color: #ffc107 !important; color: #000 !important; }
    .bg-loc-shelf { background-color: #0d6efd !important; color: #fff !important; }
    .bg-loc-bag   { background-color: #198754 !important; color: #fff !important; }
    .bg-loc-floor { background-color: #6c757d !important; color: #fff !important; }
    .bg-loc-default { background-color: #f8f9fa !important; color: #333 !important; border: 1px solid #ddd; }
  </style>
</head>

  <body>

<div id="toolOverlay">
  <div class="overlay-header">
    <h5 class="mb-0">Extra Tools | éš±è—å·¥å…·</h5>
    <button class="btn btn-sm btn-outline-light" onclick="toggleOverlay(false)">Close âœ• | é—œé–‰</button>
  </div>
  
  <div class="container py-3">
    <div class="card mb-4 shadow-sm border-danger" id="installContainer" style="display:none;">
      <div class="card-body text-center">
        <h6 class="fw-bold text-danger">Install App | å®‰è£ç³»çµ±</h6>
        <p class="small text-muted">Install to home screen for faster access.<br>å°‡ç³»çµ±å®‰è£è‡³æ¡Œé¢ä»¥å¿«é€Ÿé–‹å•Ÿã€‚</p>
        <button class="btn btn-danger w-100 fw-bold" id="btnInstallApp">INSTALL NOW | ç«‹å³å®‰è£</button>
      </div>
    </div>

    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <b>ğŸ“¦ Storage Visualizer | è²¨æ¶åˆ†ä½ˆ</b>
        <button class="btn btn-xs btn-light" onclick="refreshStorageVisual()">Refresh | åˆ·æ–°</button>
      </div>
      <div class="card-body" id="visualStorageArea">
        <p class="text-muted text-center">Loading storage data... | æ­£åœ¨è¼‰å…¥è²¨æ¶æ•¸æ“š...</p>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-dark text-white"><b>ğŸ” Unit Inquiry | å–®ä½å¾€ç¸¾</b></div>
      <div class="card-body">
        <div class="input-group mb-3">
          <input type="text" id="queryUnitInput" class="form-control" placeholder="Unit # (e.g. 1505)">
          <button class="btn btn-dark" onclick="runUnitInquiry()">Search | æŸ¥è©¢</button>
        </div>
        <div id="unitInquiryResult"></div>
      </div>
    </div>
  </div>
</div>

<div class="app-header justify-content-between">
  <div class="d-flex align-items-center">
    <img src="https://drive.google.com/thumbnail?sz=w100&id=1jo8quID7GZ8EF9OeRJ3GsbaLDEJFg7ss" class="app-logo" alt="Logo">
    <div style="line-height:1.1"><small>MET 1</small><br><b>PARCEL SYSTEM</b></div>
  </div>
  <div class="menu-trigger" onclick="toggleOverlay(true)">â˜°</div>
</div>

<div class="staff-bar">
  <label class="small fw-bold text-muted">ğŸ‘¤ Staff | è·å“¡:</label>
  <input type="text" id="currentStaff" class="staff-input" placeholder="Enter Name | è¼¸å…¥å§“å">
</div>

<div id="tab-receive" class="container py-3">
  <div class="card p-3 shadow-sm mb-3">
    <h6 class="fw-bold mb-3">ğŸ“¦ Batch Input | æ‰¹é‡éŒ„å…¥</h6>
    <div class="position-relative mb-2">
      <label class="small fw-bold text-muted">UNIT / NAME | å–®ä½ / å§“å</label>
      <input type="text" id="inputUnit" class="form-control form-control-lg" placeholder="Type to search..." autocomplete="off">
      <div id="unitDropdown" class="custom-dropdown"></div>
    </div>
    
    <div id="unitInfoBox" class="unit-info-box" style="display:none;">
      <div class="d-flex justify-content-between align-items-center">
        <span id="displayName" class="fw-bold">---</span>
        <span id="monthlyCount" class="monthly-badge">Wait...</span>
      </div>
    </div>

    <div class="row g-2 mt-2">
      <div class="col-6">
        <label class="small fw-bold text-muted">COURIER | å¿«é</label>
        <select id="inputCourier" class="form-select"></select>
      </div>
      <div class="col-6">
        <label class="small fw-bold text-muted">LOCATION | ä½ç½®</label>
        <select id="inputLocation" class="form-select"></select>
      </div>
    </div>
    <button class="btn btn-danger w-100 mt-3 py-2 fw-bold" onclick="addParcelToList()">ï¼‹ Add to List | åŠ å…¥åˆ—è¡¨</button>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-2 px-1">
    <span class="fw-bold">Pending List | å¾…è™•ç† (<span id="batchCount">0</span>)</span>
    <button class="btn btn-sm text-muted" onclick="clearBatch()">Clear | æ¸…ç©º</button>
  </div>
  <div id="batchContainer"></div>
  <button id="btnFinalSubmit" class="btn btn-dark w-100 mt-3 py-3 fw-bold shadow" style="display:none; border-radius: 10px;" onclick="showVerifyModal()">Verify & Send | æ ¸å°ä¸¦ç™¼é€</button>
</div>

<div id="tab-pickup" class="container py-3" style="display:none;">
  <div class="input-group mb-3 shadow-sm">
    <span class="input-group-text bg-white">ğŸ”</span>
    <input type="text" class="form-control border-start-0" id="searchBox" placeholder="Search Unit / Name..." onkeyup="filterParcels()">
  </div>
  <div id="parcelListArea"></div>
</div>

<div id="tab-payment" class="container py-3" style="display:none;">
  <div class="card p-3 shadow-sm">
    <h6 class="fw-bold mb-3">ğŸ’° Log Payment | è¨˜éŒ„ä»˜æ¬¾</h6>
    <div class="mb-3"><label class="small fw-bold text-muted">UNIT # | å–®ä½</label><input type="text" id="payUnit" class="form-control form-control-lg"></div>
    <div class="row g-2 mb-3">
      <div class="col-6"><label class="small fw-bold text-muted">FOR MONTH | æœˆä»½</label><input type="month" id="payMonth" class="form-control"></div>
      <div class="col-6"><label class="small fw-bold text-muted">AMOUNT | é‡‘é¡ ($)</label><input type="number" id="payAmount" class="form-control" placeholder="10"></div>
    </div>
    <div class="mb-3">
      <label class="small fw-bold text-muted">RECEIPT # / NAME | æ”¶æ“šç·¨è™Ÿ / å§“å</label>
      <div class="d-flex gap-2">
        <input type="text" id="payReceipt" class="form-control" placeholder="Receipt#">
        <input type="text" id="payBy" class="form-control" placeholder="Name">
      </div>
    </div>
    <button class="btn btn-success w-100 py-3 fw-bold" onclick="submitPayment()">Save Payment | å„²å­˜ä»˜æ¬¾</button>
  </div>
</div>

<div id="tab-history" class="container py-3" style="display:none;">
  <input type="text" class="form-control mb-3 shadow-sm" id="historySearch" placeholder="Search History..." onkeyup="searchHistory()">
  <div id="historyListArea"></div>
</div>

<div class="nav-bottom">
  <button class="nav-btn active" id="btn-nav-receive" onclick="switchTab('receive')"><div>ğŸ“¦</div>Receive</button>
  <button class="nav-btn" id="btn-nav-pickup" onclick="switchTab('pickup')"><div>ğŸ“¤</div>Pickup</button>
  <button class="nav-btn" id="btn-nav-payment" onclick="switchTab('payment')"><div>ğŸ’°</div>Pay</button>
  <button class="nav-btn" id="btn-nav-history" onclick="switchTab('history')"><div>ğŸ“œ</div>History</button>
</div>

<div class="modal fade" id="verifyModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white"><h5 class="modal-title">Final Check | æœ€å¾Œå°ç¨¿</h5></div>
      <div class="modal-body p-0">
        <table class="table table-striped mb-0 small">
          <thead class="table-light"><tr><th class="ps-3">Unit</th><th>Resident</th><th>Courier</th></tr></thead>
          <tbody id="verifyTableBody"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary flex-grow-1" data-bs-dismiss="modal">Edit | ä¿®æ”¹</button>
        <button class="btn btn-danger flex-grow-1" onclick="finalizeBatchReceive()">Confirm & Send âœ… | ç¢ºèªä¸¦ç™¼é€</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="signModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Pickup | ç¢ºèªé ˜å–</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <canvas id="signature-pad"></canvas>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="bypassSign">
          <label class="form-check-label fw-bold text-danger" for="bypassSign">Skip Signature | è·³éç°½å</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary w-100 py-4 fw-bold fs-4 shadow" onclick="processPickup()">Confirm Pickup</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
  // ================= 1. å…¨åŸŸè®Šæ•¸èˆ‡ PWA å®£å‘Š =================
  let residentData = [], tempBatch = [], allParcels = [], selectedIds = new Set(), signaturePad = null;
  let config = { locations: [], couriers: [] };
  let deferredPrompt; // ç”¨æ–¼å„²å­˜ PWA å®‰è£äº‹ä»¶

  // å¾ç¬¬ä¸€éƒ¨åˆ†ç¹¼æ‰¿çš„ APP_PIN_KEY
  // const APP_PIN_KEY = "met1_app_pin"; 
  // const WEB_APP_URL = "https://script.google.com/.../exec";

  // ================= 2. PWA æ ¸å¿ƒç›£è½ (å¿…é ˆæ”¾åœ¨æœ€å¤–å±¤) =================

  // è¨»å†Š Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(() => console.log("SW Registered"));
  }

  // ç›£è½å®‰è£æç¤º (åƒ… Android Chrome æˆ–æ¡Œé¢ç‰ˆæ”¯æ´)
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // é¡¯ç¤ºã€Œéš±è—å·¥å…·ã€ä¸­çš„å®‰è£æŒ‰éˆ•
    const installBox = document.getElementById('installContainer');
    if (installBox) installBox.style.display = 'block';
  });

  // ================= 3. æ ¸å¿ƒ API é€šè¨Š (Fetch æ¨¡å¼) =================

  async function apiCall(action, params = {}, method = 'GET') {
    const pin = localStorage.getItem(APP_PIN_KEY);
    if (!pin && action !== 'verifyPin') { checkAppPin(); return Promise.reject("Missing PIN"); }
    
    let url = `${WEB_APP_URL}?action=${action}&pin=${pin}`;
    const options = { method: method, mode: 'cors' };

    if (method === 'POST') {
      options.body = JSON.stringify(params);
    } else {
      for (let key in params) {
        if (key !== 'action' && key !== 'pin') url += `&${key}=${encodeURIComponent(params[key])}`;
      }
    }

    try {
      const response = await fetch(url, options);
      const data = await response.json();
      if (data.status === "error") throw new Error(data.message);
      return data;
    } catch (err) {
      if (err.message.includes("PIN") || err.message.includes("Access Denied")) {
        localStorage.removeItem(APP_PIN_KEY);
        checkAppPin();
      }
      console.error("API Error:", err);
      throw err;
    }
  }

  // ================= 4. åˆå§‹åŒ–èˆ‡è‡ªå‹•åŒæ­¥é‚è¼¯ =================

  window.onload = function() {
    checkAppPin();      // 1. å®‰å…¨æª¢æŸ¥
    restoreFromCache(); // 2. ç·©å­˜ç§’é–‹
    
    // è·å“¡åç¨±ç®¡ç†
    checkShiftChange();
    setInterval(checkShiftChange, 60000);
    const savedStaff = localStorage.getItem('met1_staff_name');
    if (savedStaff) document.getElementById('currentStaff').value = savedStaff;
    document.getElementById('currentStaff').oninput = (e) => {
      localStorage.setItem('met1_staff_name', e.target.value);
      localStorage.setItem('met1_staff_last_update', new Date().getTime());
    };

    // ç°½åæ¿åˆå§‹åŒ–
    const canvas = document.getElementById('signature-pad');
    if (canvas) signaturePad = new SignaturePad(canvas, { backgroundColor: 'white' });
    document.getElementById('signModal').addEventListener('shown.bs.modal', resizeCanvas);

    // ğŸš€ PWA å®‰è£æŒ‰éˆ•é»æ“Šäº‹ä»¶
    document.getElementById('btnInstallApp')?.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') document.getElementById('installContainer').style.display = 'none';
        deferredPrompt = null;
      }
    });

    // ğŸš€ è¦–çª—å¯è¦‹æ€§ç›£æ¸¬ (è§£æ±º Reload å•é¡Œ)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        console.log("App resumed, refreshing data...");
        refreshAllData();
      }
    });

    refreshAllData(); // åˆæ¬¡èƒŒæ™¯åŒæ­¥

    // UI äº‹ä»¶
    document.getElementById('inputUnit').addEventListener('input', handleUnitInput);
    document.addEventListener('click', e => { 
      if (!e.target.closest('#inputUnit')) document.getElementById('unitDropdown').style.display = 'none'; 
    });
  };

  /**
   * PIN ç¢¼ç™»å…¥
   */
  function checkAppPin() {
    if (!localStorage.getItem(APP_PIN_KEY)) {
      Swal.fire({
        title: 'System Access | ç³»çµ±ç™»å…¥',
        text: 'Enter PIN | è«‹è¼¸å…¥ 4 ä½æ•¸ PIN:',
        input: 'password',
        allowOutsideClick: false,
        confirmButtonText: 'Login | ç™»å…¥',
        confirmButtonColor: '#D00000',
        preConfirm: (v) => v || Swal.showValidationMessage('Required')
      }).then(r => {
        if (r.isConfirmed) {
          localStorage.setItem(APP_PIN_KEY, r.value);
          refreshAllData();
        }
      });
    }
  }

  /**
   * å¾æœ¬åœ°å„²å­˜æ¢å¾© (ç§’é–‹é—œéµ)
   */
  function restoreFromCache() {
    const r = localStorage.getItem('cache_residents'), c = localStorage.getItem('cache_config');
    if (r) residentData = JSON.parse(r);
    if (c) { 
      config = JSON.parse(c); 
      updateDropdowns(config); 
    }
  }

  /**
   * çµ±ä¸€å¾Œå°åŒæ­¥
   */
  function refreshAllData() {
    // åŒæ­¥ä½æˆ¶
    apiCall('getResidents').then(res => {
      residentData = res.data;
      localStorage.setItem('cache_residents', JSON.stringify(res.data));
    }).catch(e => console.warn("Residents sync failed, using cache."));

    // åŒæ­¥é…ç½®
    apiCall('getConfig').then(res => {
      config = res.data;
      localStorage.setItem('cache_config', JSON.stringify(res.data));
      updateDropdowns(res.data);
    }).catch(e => console.warn("Config sync failed."));

    // å¦‚æœåœ¨é ˜å–é é¢ï¼ŒåŒæ­¥å¾…é ˜æ¸…å–®
    if (document.getElementById('tab-pickup').style.display === 'block') loadPending();
  }

  function updateDropdowns(c) {
    const loc = document.getElementById('inputLocation'), cur = document.getElementById('inputCourier');
    if (!loc || !cur) return;
    const oldLoc = loc.value, oldCur = cur.value;
    loc.innerHTML = ""; cur.innerHTML = "";
    c.locations.forEach(l => loc.add(new Option(l, l)));
    c.couriers.forEach(r => cur.add(new Option(r, r)));
    if (oldLoc) loc.value = oldLoc;
    if (oldCur) cur.value = oldCur;
  }
/**
   * 1. è·å“¡åç¨±æ›´æ›ç­æ¬¡è‡ªå‹•æª¢æŸ¥ (ä¿®æ­£é‚è¼¯)
   */
  function checkShiftChange() {
    const now = new Date();
    const currentHour = now.getHours();
    const lastUpdate = localStorage.getItem('met1_staff_last_update');
    
    if (lastUpdate) {
      const lastDate = new Date(parseInt(lastUpdate));
      const lastHour = lastDate.getHours();
      
      // å®šç¾©æ›´æ›ç­æ¬¡æ™‚é–“ (8:00 AM å’Œ 4:00 PM)
      let currentShift = (currentHour >= 8 && currentHour < 16) ? "AM" : "PM";
      let lastShift = (lastHour >= 8 && lastHour < 16) ? "AM" : "PM";
      const isDifferentDay = now.toDateString() !== lastDate.toDateString();
      
      if (currentShift !== lastShift || isDifferentDay) {
        localStorage.removeItem('met1_staff_name');
        localStorage.removeItem('met1_staff_last_update');
        const staffInput = document.getElementById('currentStaff');
        if (staffInput) staffInput.value = "";
      }
    }
  }

  /**
   * 2. éŒ„å…¥åˆ†é ï¼šä½æˆ¶æœå°‹èˆ‡è‡ªå‹•å®Œæˆ (ä¸­è‹±æ–‡å°ç…§)
   */
  function handleUnitInput(e) {
    const v = e.target.value.toLowerCase().trim();
    const dd = document.getElementById('unitDropdown');
    const box = document.getElementById('unitInfoBox');
    dd.innerHTML = '';
    
    if (v.length < 1) { dd.style.display = 'none'; box.style.display = 'none'; return; }
    
    const m = residentData.filter(r => 
      r.unit.includes(v) || r.name.toLowerCase().includes(v) || (r.phone && r.phone.includes(v))
    ).slice(0, 10);
    
    if (m.length > 0) {
      m.forEach(i => {
        const div = document.createElement('div');
        div.className = 'dropdown-item';
        const isNoFormK = i.resType.toUpperCase().includes("NO FORM K");

        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <b>${i.unit} ${i.hasEmail ? '' : '<span class="no-email-badge">NO EMAIL</span>'}</b>
            <span class="badge ${isNoFormK ? 'bg-secondary text-white' : 'bg-light text-dark border'}" style="font-size: 0.6rem;">${i.resType}</span>
          </div>
          <div class="small text-muted">${i.name}</div>`;
        
        div.onclick = () => {
          document.getElementById('inputUnit').value = i.unit;
          dd.style.display = 'none'; box.style.display = 'block';
          window.selectedResident = i;
          document.getElementById('displayName').innerHTML = `${i.name} <small class="text-muted">(${i.resType})</small>`;
          // ğŸš€ ç²å–å–®ä½ç•¶æœˆçµ±è¨ˆ
          apiCall('getUnitStats', { unit: i.unit }).then(res => {
            document.getElementById('monthlyCount').innerText = `Monthly Total: ${res.data}`;
          });
        };
        dd.appendChild(div);
      }); 
      dd.style.display = 'block';
    }
  }

  /**
   * 3. éŒ„å…¥èˆ‡æ‰¹é‡è™•ç†
   */
  async function addParcelToList() {
    const u = document.getElementById('inputUnit').value, s = getStaffName();
    const resident = window.selectedResident;
    if (!u || !s || !resident) return;

    tempBatch.push({ 
      unit: u, residentName: resident.name, resType: resident.resType, 
      location: document.getElementById('inputLocation').value, 
      courier: document.getElementById('inputCourier').value, staffName: s 
    });
    renderBatchList();
    document.getElementById('inputUnit').value = ""; 
    document.getElementById('unitInfoBox').style.display = 'none';
  }

  function renderBatchList() {
    const c = document.getElementById('batchContainer'); c.innerHTML = "";
    tempBatch.forEach((i, idx) => {
      c.innerHTML += `
        <div class="batch-item">
          <div><b>${i.unit}</b> - ${i.residentName}<br><small class="text-muted">ğŸšš ${i.courier} | ğŸ“ <b>${i.location}</b></small></div>
          <button class="btn btn-sm btn-outline-danger" onclick="tempBatch.splice(${idx},1);renderBatchList();">âœ•</button>
        </div>`;
    });
    document.getElementById('batchCount').innerText = tempBatch.length;
    document.getElementById('btnFinalSubmit').style.display = tempBatch.length > 0 ? "block" : "none";
  }

  function clearBatch() { tempBatch = []; renderBatchList(); }

  function showVerifyModal() {
    if (tempBatch.length === 0) return;
    document.getElementById('verifyTableBody').innerHTML = tempBatch.map(i => `<tr><td class="ps-3"><b>${i.unit}</b></td><td>${i.residentName}</td><td>${i.courier}</td></tr>`).join('');
    bootstrap.Modal.getOrCreateInstance(document.getElementById('verifyModal')).show();
  }

  function finalizeBatchReceive() {
    bootstrap.Modal.getOrCreateInstance(document.getElementById('verifyModal')).hide();
    Swal.fire({ title: 'Sending | ç™¼é€ä¸­...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    apiCall('receiveBatch', tempBatch, 'POST').then(r => {
      Swal.fire("Success!", `Saved ${r.count} parcels`, "success"); clearBatch();
    }).catch(e => Swal.fire("Error", e.message, "error"));
  }

  /**
   * 4. é ˜å–åŒ…è£¹åŠŸèƒ½ (Pickup)
   */
  function loadPending() {
    const area = document.getElementById('parcelListArea');
    area.innerHTML = '<div class="text-center py-5 text-muted small">Loading...</div>';
    selectedIds.clear();
    apiCall('getPending').then(res => { 
      allParcels = res.data; 
      renderPickupList(res.data); 
    });
  }

  function renderPickupList(d) {
    const a = document.getElementById('parcelListArea'); 
    a.innerHTML = d.length === 0 ? '<div class="text-center py-5">Empty ğŸ‰</div>' : '';
    d.forEach(p => {
      const isSelected = selectedIds.has(p.id);
      const colorClass = getLocationColorClass(p.location);
      a.innerHTML += `
        <div class="parcel-card d-flex align-items-center ${isSelected?'selected':''}" onclick="toggleSelect('${p.id}')">
          <div class="custom-check"></div>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between">
              <b>${p.unit}</b>
              <span class="badge ${colorClass} shadow-sm">${p.location}</span>
            </div>
            <div class="small">${p.name} | ${p.courier}</div>
            <div class="text-muted" style="font-size:0.7rem">${p.time}</div>
          </div>
        </div>`;
    });
    if (selectedIds.size > 0) {
      a.innerHTML += `<button class="btn btn-primary position-fixed shadow-lg py-3 fw-bold" style="bottom:80px; left:20px; right:20px; z-index:999" onclick="openSignModal()">Confirm Pickup (${selectedIds.size})</button>`;
    }
  }

  function toggleSelect(id) { if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); filterParcels(); }
  function filterParcels() { const v = document.getElementById('searchBox').value.toLowerCase().trim(); renderPickupList(allParcels.filter(p => p.unit.includes(v) || p.name.toLowerCase().includes(v))); }
  function getLocationColorClass(loc) { if (!loc) return 'bg-loc-default'; const l = loc.toLowerCase(); if (l.includes('lobby')) return 'bg-loc-lobby'; if (l.includes('shelf')) return 'bg-loc-shelf'; if (l.includes('bag')) return 'bg-loc-bag'; if (l.includes('floor')) return 'bg-loc-floor'; return 'bg-loc-default'; }

  function openSignModal() { if (!getStaffName()) return; document.getElementById('bypassSign').checked = false; bootstrap.Modal.getOrCreateInstance(document.getElementById('signModal')).show(); }

  async function processPickup() {
    const b = document.getElementById('bypassSign').checked;
    if (!b && signaturePad.isEmpty()) return Swal.fire("Signature Required", "", "warning");
    const sign = b ? "" : signaturePad.toDataURL().split(',')[1];
    bootstrap.Modal.getOrCreateInstance(document.getElementById('signModal')).hide();
    Swal.fire({ title: 'Processing...', didOpen: () => Swal.showLoading() });
    apiCall('pickupParcels', { ids: Array.from(selectedIds), signBase64: sign, bypass: b, staffName: getStaffName() }, 'POST').then(() => {
      Swal.fire("Success", "", "success"); loadPending();
    });
  }

  /**
   * 5. ä»˜æ¬¾ã€æ­·å²èˆ‡å·¥å…·
   */
  function submitPayment() {
    const s = getStaffName(); if (!s) return;
    const f = { unit: document.getElementById('payUnit').value, forMonth: document.getElementById('payMonth').value, amount: document.getElementById('payAmount').value, receipt: document.getElementById('payReceipt').value, paidBy: document.getElementById('payBy').value, staffName: s };
    if (!f.unit || !f.amount) return Swal.fire("Error", "Fill Data", "error");
    apiCall('logPayment', f, 'POST').then(() => { Swal.fire("Saved", "", "success"); document.getElementById('payUnit').value=''; });
  }

  function searchHistory() {
    const v = document.getElementById('historySearch').value;
    apiCall('getArchived', { search: v }).then(res => {
      const a = document.getElementById('historyListArea'); a.innerHTML = res.data.length === 0 ? '<div class="text-center py-5">No records</div>' : '';
      res.data.forEach(p => {
        a.innerHTML += `<div class="parcel-card d-flex justify-content-between align-items-center"><div><b>${p.unit}</b> - ${p.name}<br><small>${p.courier} | Out: ${p.timeOut}</small></div><button class="btn btn-sm btn-outline-danger" onclick="confirmRestore('${p.id}','${p.unit}')">Restore</button></div>`;
      });
    });
  }

  function confirmRestore(id, u) {
    if (!getStaffName()) return;
    Swal.fire({ title: 'Restore?', text: `Unit ${u}`, showCancelButton: true }).then(r => {
      if (r.isConfirmed) apiCall('restoreParcel', { parcelId: id }, 'POST').then(() => searchHistory());
    });
  }

  function refreshStorageVisual() {
    const area = document.getElementById('visualStorageArea');
    area.innerHTML = 'Loading...';
    apiCall('getPending').then(res => {
      const parcels = res.data; area.innerHTML = "";
      ["Shelf", "Floor", "Bag", "Letter"].forEach(loc => {
        const list = parcels.filter(p => p.location.toLowerCase().includes(loc.toLowerCase()));
        if (list.length > 0) {
          area.innerHTML += `<div class="location-header">${loc.toUpperCase()}</div><div class="unit-container">${list.map(p => `<span class="unit-tag">${p.unit}</span>`).join('')}</div>`;
        }
      });
    });
  }

  function runUnitInquiry() {
    const u = document.getElementById('queryUnitInput').value; if (!u) return;
    apiCall('getUnitDetailedHistory', { unit: u }).then(res => {
      const d = res.data;
      document.getElementById('unitInquiryResult').innerHTML = `
        <div class="alert ${d.balance > 0 ? 'alert-danger' : 'alert-success'} small">
          <b>Balance: $${d.balance}</b><br>Fee: $${d.totalFeeOwed} | Paid: $${d.totalPaid}
        </div>`;
    });
  }

  function switchTab(t) {
    ['receive', 'pickup', 'payment', 'history'].forEach(x => {
      document.getElementById(`tab-${x}`).style.display = (x === t ? 'block' : 'none');
      document.getElementById(`btn-nav-${x}`).classList.toggle('active', x === t);
    });
    if (t === 'pickup') loadPending();
    if (t === 'history') searchHistory();
  }

  function getStaffName() { const n = document.getElementById('currentStaff').value.trim(); if (!n) Swal.fire("Staff Name Required", "", "warning"); return n; }
  function resizeCanvas() { const c = document.getElementById('signature-pad'); const r = window.devicePixelRatio || 1; c.width = c.offsetWidth * r; c.height = c.offsetHeight * r; c.getContext("2d").scale(r, r); signaturePad.clear(); }
  function toggleOverlay(s) { document.getElementById('toolOverlay').style.display = s ? 'block' : 'none'; if (s) refreshStorageVisual(); }

</script>
</body>
</html>
